/***************************************************************
   ƒNƒ‰ƒŠƒIƒ““aŒü‚¯ 
   ƒvƒƒWƒFƒNƒg–¼   F2012”NAMFM_RADIOÓÃÞÙ
   ƒtƒ@ƒCƒ‹–¼      Falm_mode.c
   ƒ‚ƒWƒ…[ƒ‹–¼   FSUBƒ‚[ƒh(ALARM)
   ‹@   ”\         FALARM’²®ˆ—
----------------------------------------------------------------
C³—š—ð   y”NŒŽ“úzyVersionzy–¼‘Oz yà–¾z
----------------------------------------------------------------
         2012/7/24      0.1      lrj      V‹K
****************************************************************/
#define   _ALM_MODE_C_

#include   "../model.h"

#include   "../comm/common.h"
#include   "../disp/lcd_ext.h"
#include   "../key/key_func_ext.h"
#include   "../audio/aud_ext.h"
#include   "../main/ma_ext.h"
#include   "../power/pw_func_ext.h"

#include   "sbm_def.h"
#include   "sbm_ext.h"
#include   "sbm_sys.h"
#include   "sbm_keytbl.h"

/******************************************************************************
      ŠÖ”–¼  FAlm_lcddata_set
      ˆø  ”   F–³‚µ
      –ß‚è’l   F–³‚µ
      ‹@  ”\   FAlarm•\Ž¦ÃÞ°Àì¬ˆ—
----------------------------------------------------------------
C³—š—ð   y”NŒŽ“úzyVersionzy–¼‘Oz yà–¾z
----------------------------------------------------------------
         2012/7/24      0.1      lrj      V‹K
******************************************************************************/
void Alm_lcddata_set( TDP_CLK *almdisp )
{
   if (sbm_alm_adj.hour == 0)
   {
      almdisp->hour = 12;
   }
   else if ((sbm_alm_adj.hour >= 13)&&(sbm_alm_adj.hour <= 23))
   {
      almdisp->hour = sbm_alm_adj.hour - 12;
   }
   else
   {
      almdisp->hour = sbm_alm_adj.hour;
   }
   almdisp->min = sbm_alm_adj.min;
   almdisp->mode = sbm_alm_mode;
}

BYTE Alm_indicator_set(void)
{
   BYTE   indicator;
   
   indicator = 0;
   
   if ((sbm_alm_adj.hour >= 12)&&(sbm_alm_adj.hour <= 23))
   {
      indicator |= CLCD_CL_IND_PM;
   }
   else
   {
      indicator |= CLCD_CL_IND_AM;
   }
   return (indicator);
}

BOOL Alm_bell_indicator_set(void)
{
   return (fsbm_alm_onoff);  // nam trong file sbm_def.h
}

/******************************************************************************
      ŠÖ”–¼  FAlm_mode_start
      ˆø  ”   F–³‚µ
      –ß‚è’l   F–³‚µ
      ‹@  ”\   FAlarm’²®ƒ‚[ƒh“ü‚éˆ—
----------------------------------------------------------------
C³—š—ð   y”NŒŽ“úzyVersionzy–¼‘Oz yà–¾z
----------------------------------------------------------------
         2012/7/24      0.1      lrj      V‹K
******************************************************************************/
void Alm_mode_start(void)
{
   if (Ma_get_alarm() == FALSE )
   {
      Key_nop();
      return;
   }
   
   Lcd_base_disp_cancel();
   Vol_mode_cancel();
   sbm_alm_mode = CSBM_ALM_ADJUST;
   fsbm_alm_onoff = ON;
   sbm_alm_tim = CSBM_ALM_15S;
   Lcd_blktim_set();
   
   #if 0   /* AM1:00‚©‚çŒÅ’è */
   if (fsbm_alm_setted == FALSE)
   {
      #if 0
      sbm_alm_adj = sbm_clk_adj;
      #else
      sbm_alm_adj.min = sbm_clk_adj.min;
      sbm_alm_adj.hour = sbm_clk_adj.hour;      
      #endif
   }
   #endif
   
   Key_nop();
}
/******************************************************************************
      ŠÖ”–¼  FAlm_mode_check
      ˆø  ”   F–³‚µ
      –ß‚è’l   FON ËAlarm’²®’†
            FOFF Ë Alarm’²®’†‚Å‚Í‚È‚¢
      ‹@  ”\   FAlarm’²®ƒ‚[ƒh’†‚©ƒ`ƒFƒbƒN
----------------------------------------------------------------
C³—š—ð   y”NŒŽ“úzyVersionzy–¼‘Oz yà–¾z
----------------------------------------------------------------
         2012/7/24      0.1      lrj      V‹K
******************************************************************************/
BYTE Alm_mode_check(void)
{
   if(sbm_alm_mode != CSBM_ALM_NORMAL)  // sbm_alm_mode va CSBM_ALM_NORMAL=0 duoc khoi tao trong file sbm_def.h
                                        // sbm_alm_mode duoc khoi tao lan dau voi gia tri CSBM_ALM_NORMAL trong ham Alm_mode_initial cua file alm_mode.c
   {
      return(ON);
   }
   else                // Khi mode cua alarm la NORMAL thi tra ve OFF
   {
      return(OFF);
   }
}
/******************************************************************************
      ŠÖ”–¼  FAlm_mode_cancel
      ˆø  ”   F–³‚µ
      –ß‚è’l   F–³‚µ
      ‹@  ”\   FAlarm’²®ƒ‚[ƒh’†·¬Ý¾Ùˆ—
----------------------------------------------------------------
C³—š—ð   y”NŒŽ“úzyVersionzy–¼‘Oz yà–¾z
----------------------------------------------------------------
         2012/7/24      0.1      lrj      V‹K
******************************************************************************/
void Alm_mode_cancel(void)
{
   sbm_alm_mode = CSBM_ALM_NORMAL;
   sbm_alm_tim = 0;
   //fsbm_alm_onoff = ON;
   fsbm_beep_en = OFF;
   #if 0
   fsbm_alm_setted = ON;
   Pw_almkey_clear();
   #endif
}
/******************************************************************************
      ŠÖ”–¼  FAlm_mode_hour_up
      ˆø  ”   FUP/DW
      –ß‚è’l   F–³‚µ
      ‹@  ”\   FAlarm’²®Ó°ÄÞ’†HOUR‚ÌUP’²®
----------------------------------------------------------------
C³—š—ð   y”NŒŽ“úzyVersionzy–¼‘Oz yà–¾z
----------------------------------------------------------------
         2012/7/24      0.1      lrj      V‹K
******************************************************************************/
void Alm_mode_hour_up(void)
{
#if 0
   sbm_alm_adj.hour++;
   if( sbm_alm_adj.hour == 24 )
   {
      sbm_alm_adj.hour = 0;
   }
   if( sbm_alm_adj.hour < 12 )
   {
      fsbm_alm_ampm = CSBM_CLK_AM;
   }
   else
   {
      fsbm_alm_ampm = CSBM_CLK_PM;
   }
#else
   #if 0
   if( sbm_alm_adj.hour == 11 )
   {
      if( fsbm_alm_ampm == CSBM_CLK_AM )
      {
         sbm_alm_adj.hour++;
         fsbm_alm_ampm = CSBM_CLK_PM;
      }
      else
      {
         sbm_alm_adj.hour = 0;
         fsbm_alm_ampm = CSBM_CLK_AM;
      }
   }
   else if( sbm_alm_adj.hour == 12 )
   {
      sbm_alm_adj.hour = 1;
   }
   else
   {
      sbm_alm_adj.hour++;
   }
   #endif
   
   /* ŽžƒJƒEƒ“ƒg */
   if( sbm_alm_adj.hour >= 23 )
   {
      sbm_alm_adj.hour = 0;
   }
   else
   {
      sbm_alm_adj.hour++;
   }
   
   #if 0
   /* AM‚©PM‚ÌÝ’è */
   if(( sbm_alm_adj.hour >= 12)&&(sbm_alm_adj.hour <= 23))
   {
      fsbm_clk_ampm = CSBM_CLK_PM;
   }
   else
   {
      fsbm_clk_ampm = CSBM_CLK_AM;
   }
   #endif
#endif
   
   sbm_alm_tim = CSBM_ALM_15S;
   Lcd_blktim_set();         /* “_–ÅÀ²ÏÄÝ’è */
}
/******************************************************************************
      ŠÖ”–¼  FAlm_mode_min_up
      ˆø  ”   F–³‚µ
      –ß‚è’l   F–³‚µ
      ‹@  ”\   FAlarm’²®Ó°ÄÞ’†MIN‚ÌUP’²®
----------------------------------------------------------------
C³—š—ð   y”NŒŽ“úzyVersionzy–¼‘Oz yà–¾z
----------------------------------------------------------------
         2012/7/24      0.1      lrj      V‹K
******************************************************************************/
void Alm_mode_min_up(void)
{
   sbm_alm_adj.min++;
   if( sbm_alm_adj.min == 60 )
   {
      sbm_alm_adj.min = 0;
   }
   
   sbm_alm_tim = CSBM_ALM_15S;
   Lcd_blktim_set();         /* “_–ÅÀ²ÏÄÝ’è */
}
/******************************************************************************
      ŠÖ”–¼  FAlm_mode_set
      ˆø  ”   F–³‚µ
      –ß‚è’l   F–³‚µ
      ‹@  ”\   FAlarm’²®Ï‚Ýƒf[ƒ^Šm’è
----------------------------------------------------------------
C³—š—ð   y”NŒŽ“úzyVersionzy–¼‘Oz yà–¾z
----------------------------------------------------------------
         2012/7/24      0.1      lrj      V‹K
******************************************************************************/
void Alm_mode_set(void)
{
   #if 0
   sbm_alm_mode = CSBM_ALM_NORMAL;
   sbm_alm_tim = 0;
   fsbm_alm_onoff = ON;
   fsbm_beep_en = ON;
   fsbm_alm_setted = ON;
   #else
   Alm_mode_cancel();
   Key_nop();
   #endif
}
/******************************************************************************
      ŠÖ”–¼  FAlm_onoff_set
      ˆø  ”   F–³‚µ
      –ß‚è’l   F–³‚µ
      ‹@  ”\   FAlarm ONOFFó‘ÔÝ’è
----------------------------------------------------------------
C³—š—ð   y”NŒŽ“úzyVersionzy–¼‘Oz yà–¾z
----------------------------------------------------------------
         2012/7/24      0.1      lrj      V‹K
******************************************************************************/
void Alm_onoff_set(void)
{
   if (Ma_get_alarm() == FALSE )
   {
      Key_nop();
      return;
   }
   
   fsbm_alm_onoff = ~fsbm_alm_onoff;
   fsbm_beep_en = OFF;
   Lcd_1shot_cancel(CLCD_1SHOT_OFF);         /* ˆêŽž•\Ž¦·¬Ý¾Ù */
   /* Lcd_send_req(); */
   Lcd_accoff_send_req();
   Key_nop();
}
/******************************************************************************
      ŠÖ”–¼  FAlm_beepon_get
      ˆø  ”   F–³‚µ
      –ß‚è’l   FON/OFF
      ‹@  ”\   Fbeep–Â“®’†‚©‚Ç‚¤‚©Žæ“¾
----------------------------------------------------------------
C³—š—ð   y”NŒŽ“úzyVersionzy–¼‘Oz yà–¾z
----------------------------------------------------------------
         2012/7/24      0.1      lrj      V‹K
******************************************************************************/
BOOL Alm_beepon_get(void)
{
   return(fsbm_alm_beepon);
}
/******************************************************************************
      ŠÖ”–¼  FAlm_beepon_get
      ˆø  ”   F–³‚µ
      –ß‚è’l   FON/OFF
      ‹@  ”\   Fbeep–Â“®’†‚©‚Ç‚¤‚©Žæ“¾
----------------------------------------------------------------
C³—š—ð   y”NŒŽ“úzyVersionzy–¼‘Oz yà–¾z
----------------------------------------------------------------
         2012/7/24      0.1      lrj      V‹K
******************************************************************************/
void Alm_key_pwr_on(void)
{
   /* ƒAƒ‰[ƒ€ƒLƒƒƒ“ƒZƒ‹—v‹‚ðo‚· */
   fsbm_alm_off_req = TRUE;
   
   Pw_power_key();
   Key_nop();
}

/******************************************************************************
      ŠÖ”–¼  FAlm_key_up_off
      ˆø  ”   F–³‚µ
      –ß‚è’l   F–³‚µ
      ‹@  ”\   FAlarm’²®ƒ‚[ƒhUP·°OFFˆ—
----------------------------------------------------------------
C³—š—ð   y”NŒŽ“úzyVersionzy–¼‘Oz yà–¾z
----------------------------------------------------------------
         2012/7/24      0.1      lrj      V‹K
******************************************************************************/
void Alm_key_up_off(void)
{
   Alm_mode_min_up();
   Key_nop();
}
/******************************************************************************
      ŠÖ”–¼  FAlm_key_up_long
      ˆø  ”   F–³‚µ
      –ß‚è’l   F–³‚µ
      ‹@  ”\   FAlarm’²®ƒ‚[ƒhUP·°LONGˆ—
----------------------------------------------------------------
C³—š—ð   y”NŒŽ“úzyVersionzy–¼‘Oz yà–¾z
----------------------------------------------------------------
         2012/7/24      0.1      lrj      V‹K
******************************************************************************/
void Alm_key_up_long(void)
{
   Alm_mode_min_up();
   Key_long_time200();
}
/******************************************************************************
      ŠÖ”–¼  FAlm_key_dw_off
      ˆø  ”   F–³‚µ
      –ß‚è’l   F–³‚µ
      ‹@  ”\   FAlarm’²®ƒ‚[ƒhDOWN·°OFFˆ—
----------------------------------------------------------------
C³—š—ð   y”NŒŽ“úzyVersionzy–¼‘Oz yà–¾z
----------------------------------------------------------------
         2012/7/24      0.1      lrj      V‹K
******************************************************************************/
void Alm_key_dw_off(void)
{
   Alm_mode_hour_up();
   Key_nop();
}
/******************************************************************************
      ŠÖ”–¼  FAlm_key_dw_long
      ˆø  ”   F–³‚µ
      –ß‚è’l   F–³‚µ
      ‹@  ”\   FAlarm’²®ƒ‚[ƒhDOWN·°LONGˆ—
----------------------------------------------------------------
C³—š—ð   y”NŒŽ“úzyVersionzy–¼‘Oz yà–¾z
----------------------------------------------------------------
         2012/7/24      0.1      lrj      V‹K
******************************************************************************/
void Alm_key_dw_long(void)
{
   Alm_mode_hour_up();
   Key_long_time200();
}

void Alm_key_tisc_on(void)
{
   BYTE   destno;
   
   destno = Ma_model_dest();/*ŽdŒü‚¯NoŽæ“¾*/
   
   if ((destno == CMA_MODEL_AMFM_J)&&(Pw_Power_status_get() == ON))
   {
      Tu_key_isr_on();/*TIƒ‚[ƒh‚Ö‘JˆÚ*/
   }
   
   Key_nop();/*–³Œø*/
}

/******************************************************************************
      ŠÖ”–¼  FAlm_beep_stop
      ˆø  ”   F–³‚µ
      –ß‚è’l   F–³‚µ
      ‹@  ”\   FAlarm beep onŽžAbeep–Â“®’âŽ~ˆ—
----------------------------------------------------------------
C³—š—ð   y”NŒŽ“úzyVersionzy–¼‘Oz yà–¾z
----------------------------------------------------------------
         2012/7/25      0.1      lrj      V‹K
******************************************************************************/
void Alm_beep_on_stop(void)
{
   fsbm_alm_beepon = OFF;
   Pw_acc_wakeup_req(OFF);
}

/******************************************************************************
      ŠÖ”–¼  FAlm_beep_key_stop
      ˆø  ”   F–³‚µ
      –ß‚è’l   F–³‚µ
      ‹@  ”\   FAlarm beep onŽžAPowerˆÈŠO‚Ì·°ONˆ—
----------------------------------------------------------------
C³—š—ð   y”NŒŽ“úzyVersionzy–¼‘Oz yà–¾z
----------------------------------------------------------------
         2012/7/25      0.1      lrj      V‹K
******************************************************************************/
void Alm_beep_key_stop(void)
{
   Sbm_mode_cancel(CSBM_OFF);
   Aud_cancel_beep();   /* beep off */
   Alm_beep_on_stop();
   Key_nop();
}
void Alm_key_volupon(void)
{
   if (Pw_Power_status_get() == ON)
   {
      Sbm_key_volupon();
   }
   else
   {
      Key_nop();
   }
}
void Alm_key_voluplong(void)
{
   Alm_mode_cancel();
   Sbm_key_voluplong();
}
void Alm_key_volupoff(void)
{
   Alm_mode_cancel();
   Sbm_key_volupoff();
}
void Alm_key_voldwon(void)
{
   if (Pw_Power_status_get() == ON)
   {
      Sbm_key_voldwon();
   }
   else
   {
      Key_nop();
   }
}
void Alm_key_voldwlong(void)
{
   Alm_mode_cancel();
   Sbm_key_voldwlong();
}
void Alm_key_voldwoff(void)
{
   Alm_mode_cancel();
   Sbm_key_voldwoff();
}

/******************************************************************************
      ŠÖ”–¼  FAlm_time_initial
      ˆø  ”   F–³‚µ
      –ß‚è’l   F–³‚µ
      ‹@  ”\   FAlarmŽž‰Šú‰»ˆ—
----------------------------------------------------------------
C³—š—ð   y”NŒŽ“úzyVersionzy–¼‘Oz yà–¾z
----------------------------------------------------------------
         2012/7/30      0.1      lrj      V‹K
******************************************************************************/
void Alm_mode_initial(void)
{
   sbm_alm_adj.min = 0x00;
   sbm_alm_adj.hour = 0x01;
   sbm_alm_bak.min = 0x00;
   sbm_alm_bak.hour = 0x01;
   sbm_alm_tim = 0;
   sbm_alm_mode = CSBM_ALM_NORMAL;
}














#undef _ALM_MODE_C_
